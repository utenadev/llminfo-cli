# Python CLIアプリケーション設計の考え方

このドキュメントは、Pythonを用いたコマンドラインインターフェース（CLI）アプリケーションを開発する際の、汎用的な設計指針とベストプラクティスをまとめたものです。
プロジェクトの規模や要件に応じて、これらのルールを柔軟に適用・調整してください。

## 1. ドキュメント体系の考え方

プロジェクトの規模に関わらず、「何を作るか（仕様）」と「どう作るか（設計）」を明確にすることは重要です。

### 1.1 要件定義 (Specifications)
- **目的**: ユーザーが何を求めているか、システムが何を満たすべきかを定義する。
- **推奨ファイル名**: `SPEC.md`, `REQUIREMENTS.md`
- **内容の目安**:
    - **小規模**: コマンドの使い方と期待される出力の箇条書き。
    - **中〜大規模**: 機能要件（FR）、非機能要件（NF）、セキュリティ要件、対応プラットフォームなどを構造化して記述。

### 1.2 設計詳細 (Blueprint/Architecture)
- **目的**: 実装の方針、技術選定、内部構造を定義する。
- **推奨ファイル名**: `BLUEPRINT.md`, `DESIGN.md`, `ARCHITECTURE.md`
- **内容の目安**:
    - **小規模**: 主要な関数やクラスの役割説明。
    - **中〜大規模**: ディレクトリ構成、依存ライブラリ選定理由、アーキテクチャ図、データフロー、拡張性（プラグイン等）の設計。

## 2. 設計原則 (Design Principles)

### 2.1 モジュールアーキテクチャ
- **関心の分離**:
    - **UI層 (CLI)**: ユーザー入出力、引数解析のみを担当し、ビジネスロジックを含めない。
    - **コアロジック層**: アプリケーションの主要機能を実装。CLIライブラリに依存しないことが望ましい。
    - **データ/アダプター層**: 外部API、データベース、ファイルシステムとのやり取りを抽象化する。
- **依存性の注入 (DI)**:
    - テスト容易性を高めるため、外部依存（HTTPクライアント、時計、ファイル操作など）はインターフェース（抽象クラス）を介して注入する設計を推奨。

### 2.2 設定管理 (Configuration)
- **優先順位**: 以下の順序で設定を適用するのが一般的です。
    1. コマンドライン引数（最優先）
    2. 環境変数（APIキーやシークレット）
    3. 設定ファイル（`config.yml`, `pyproject.toml` など）
    4. デフォルト値
- **機密情報**: APIキーやパスワードは決してコードや設定ファイルにコミットせず、環境変数または `.env` ファイルから読み込む。

### 2.3 エラーハンドリングとユーザー体験
- **終了コード**: 正常終了は `0`、エラーは `1` (または適切な非ゼロ値) を返す。
- **出力の使い分け**:
    - **Stdout**: パイプライン処理で利用可能な、加工しやすいデータ（JSONなど）。
    - **Stderr**: ログ、進捗バー、エラーメッセージ、ユーザーへの対話的メッセージ。
- **例外処理**:
    - ユーザーには「何が起きたか」と「どうすればよいか」を行動可能なメッセージとして表示する。
    - 開発者向けのスタックトレースは、デバッグモード（`--debug`）時のみ表示する。

## 3. プロジェクト規模別の適用ガイド

### Level 1: スクリプト / プロトタイプ
- **構成**: 単一ファイル (`main.py`) またはフラットな構成。
- **設計**: 関数ベース。設定は定数や `argparse` で十分。
- **ドキュメント**: `README.md` に使い方を書くのみ。

### Level 2: ツール / ユーティリティ (本リポジトリの想定)
- **構成**: パッケージ構成 (`src/appname` または `appname/`)。
- **設計**: クラスを用いた責務の分離。`Typer`/`Click` などのCLIフレームワーク利用。設定ファイルのサポート。
- **ドキュメント**: 設計思想やセットアップ手順を文書化。

### Level 3: プラットフォーム / フレームワーク
- **構成**: 複数のサブパッケージ、プラグイン機構。
- **設計**: 厳格なレイヤードアーキテクチャ、ドメイン駆動設計(DDD)の導入検討。
- **ドキュメント**: 完全なAPIリファレンス、貢献ガイドライン (`CONTRIBUTING.md`)、ADR (Architecture Decision Records)。

## 4. 将来の拡張性
- **変更への備え**: 外部APIの仕様変更やライブラリの廃止に備え、ラッパー層を設ける。
- **機能追加フロー**: 新機能追加時は、まずドキュメント（仕様・設計）を更新してからコードを書く「ドキュメントファースト」を推奨。
