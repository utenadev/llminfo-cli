# Python CLI開発とテストの考え方

このドキュメントは、保守性が高く品質の安定したPython CLIアプリケーションを開発するための、コーディングとテストに関する指針です。

## 1. 推奨技術スタック

プロジェクトの要件に合わせて適切なツールを選定しますが、現代的なPython CLI開発では以下のようなスタックが標準的です。

### 1.1 コアライブラリ
- **CLIフレームワーク**:
    - `Typer`: 型ヒントを活用した現代的で記述量が少ないフレームワーク（推奨）。
    - `Click`: 堅牢で拡張性が高い、Typerの基盤。
    - `argparse`: 標準ライブラリのみで完結させたい場合。
- **データ検証・設定**:
    - `Pydantic`: 強力なデータバリデーションと設定管理。
- **HTTPクライアント** (Web API利用時):
    - `HTTPX`: 同期/非同期両対応の現代的なクライアント。
    - `Requests`: 同期処理のみで十分な場合のデファクトスタンダード。
- **UI/フォーマット**:
    - `Rich`: 美しいターミナル出力（色、テーブル、プログレスバー）。

### 1.2 開発・品質管理ツール
- **タスクランナー**: `Task` (go-task), `Makefile` - コマンドの抽象化と自動化。
- **パッケージ管理**: `Hatch`, `Poetry`, `uv` - 依存関係とビルド管理。
- **リンター/フォーマッター**: `Ruff` - 高速で多機能な静的解析ツール。
- **型チェック**: `Mypy`, `Pyright` - 静的型安全性。
- **テスト**: `Pytest` - 強力なフィクスチャとエコシステム。

## 2. コーディング標準

### 2.1 型アノテーション (Type Hinting)
- **原則**: Python 3.10+ の構文を活用し、可能な限り型ヒントを記述する。
- **Strictness**:
    - **L1 (Script)**: 主要な関数の引数と戻り値のみ。
    - **L2 (Tool)**: すべての定義に型ヒント記述。`Any` の使用を避ける。
    - **L3 (Platform)**: `mypy --strict` 準拠。ジェネリクスやProtocolの活用。

### 2.2 実装パターン
- **Strategyパターン**: 出力形式（JSON/Text）や、外部サービス（AWS/GCP/Azure）の切り替えに利用。
- **Factoryパターン**: 設定値に基づいて適切なクラスインスタンスを生成するために利用。
- **非同期処理 (Asyncio)**: I/O待ち（ネットワーク、ファイル）が多いCLIツールでは、`asyncio` を活用してパフォーマンスを向上させる。

## 3. テスト戦略

### 3.1 テストのピラミッド
- **単体テスト (Unit)**: 外部依存をモック化し、ロジック単体を検証。高速に動作させる。
- **統合テスト (Integration)**: 実際のファイルシステムや（可能な範囲で）外部API、またはローカルコンテナとの連携を検証。
- **E2Eテスト**: CLIコマンドとして実際にバイナリを実行し、入出力を検証。

### 3.2 モッキングの指針
- 外部APIへのリクエストは必ずモックする（テストの安定性と速度のため）。
- `pytest-mock` などを利用し、副作用（APIコール、ファイル削除など）が発生しないことを保証する。

## 4. 開発プロセスの自動化 (Task Automation)

開発者の環境差異を吸収し、手順を文書化する代わりに実行可能なタスク定義ファイルを用意することを強く推奨します。

### 4.1 タスクランナーの導入 (推奨: Taskfile)
複雑なシェルコマンドを覚えなくても良いように、以下のようなタスクを定義します。

- `task setup`: 開発環境の構築（venv作成、依存インストール）。
- `task test`: テストの実行。
- `task lint`: コードスタイルのチェックと修正。
- `task build`: 配布用パッケージの作成。

### 4.2 CI/CD
GitHub ActionsなどのCIツールで、プルリクエストごとに以下を自動実行します。
1. **Lint**: コード規約違反がないか。
2. **Type Check**: 型エラーがないか。
3. **Test**: テストがパスするか（複数のPythonバージョンで確認）。

## 5. ディレクトリ構造の例

### フラットレイアウト (小規模)
```
mytool/
├── main.py
├── utils.py
├── requirements.txt
└── tests/
```

### srcレイアウト (中〜大規模・推奨)
インストール時のトラブルを防ぎ、パッケージングを明確にする構成。
```
mytool/
├── src/
│   └── mytool/
│       ├── __init__.py
│       ├── main.py
│       ├── core/
│       └── adapters/
├── tests/
├── pyproject.toml
├── Taskfile.yml
└── README.md
```
