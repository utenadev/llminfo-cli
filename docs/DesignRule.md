# ソフトウェア設計ルール

## 1. 設計文書の構造

### 1.1 仕様書（SPEC.md）
- **目的**: ユーザー要件、機能要件、技術制約の定義
- **内容構成**:
  - 概要とユーザーニーズ
  - 機能要件（FR-XXX形式）
  - 非機能要件（NF-XXX形式）
  - 技術制約 (Python 3.11+ 等)
  - セキュリティ要件
  - 運用環境
  - 配布形式

### 1.2 詳細設計書（BLUEPRINT.md）
- **目的**: 技術的な詳細設計と実装ガイドライン
- **内容構成**:
  - 技術スタック（Python, Typer, HTTPX, Pydantic, PyYAML, Rich, Aiofiles）
  - プロジェクト構成とディレクトリレイアウト
  - 詳細設計セクション:
    - アーキテクチャパターン (Provider, Strategy)
    - CLIコマンド構成 (credits, list, test-provider, import-provider)
    - 出力形式 (Table, JSON)
    - エラーハンドリングパターン (Custom Exceptions)
    - テスト戦略 (Unit, Integration)
    - 配布設定 (Hatchling)
  - 実装フェーズ
  - 将来のマイルストーン

## 2. 設計原則

### 2.1 モジュールアーキテクチャ
- **パターン**: 抽象ベースクラス (`Provider`) と具象実装の分離
- **戦略パターン**: 異なるAPIフォーマットに対するレスポンスパーサー (`ResponseParser`)
- **関心の分離**: CLI (`main.py`), プロバイダー (`providers/`), キャッシュ (`cache.py`), データモデル (`schemas.py`) の明確な分離

### 2.2 設定管理
- **YAMLベース**: `providers.yml` でプロバイダーを一元管理
- **環境変数**: APIキーなどの機密情報は環境変数 (`.env`) に保存
- **プラグインシステム**: `plugin/` ディレクトリ内のYAMLファイルで新規プロバイダーをテストし、`import-provider` コマンドで取り込む

### 2.3 エラーハンドリング
- **HTTPステータスコード**: 401（認証エラー）、429（レート制限）などを `APIError` などのカスタム例外にマッピング
- **ユーザーフレンドリー**: CLIユーザーにはスタックトレースではなく、行動可能なメッセージを表示
- **グレースフルデグラデーション**: キャッシュ活用による耐障害性向上

## 3. 開発ルール

### 3.1 機能要件
- **ユーザーニーズ優先**: すべての機能は `SPEC.md` に定義されたニーズに対応
- **機能要件**: 各機能には対応するFR-XXXエントリが必要
- **非機能要件**: キャッシュTTLやレスポンス速度などの要件を定義

### 3.2 技術制約
- **言語バージョン**: Python 3.11+ (プロジェクト設定に準拠)
- **依存関係**: `pyproject.toml` で管理される最小限の依存関係
- **API互換性**: 可能な限りOpenAI互換API標準に準拠
- **セキュリティ**: HTTPSのみ使用、APIキーはログ出力しない

### 3.3 実装パターン
- **汎用実装**: OpenAI互換APIは `GenericProvider` + `providers.yml` 設定で対応
- **カスタム実装**: 特殊な仕様（OpenRouter等）は `Provider` サブクラスを実装
- **バリデーション**: `pydantic` モデルと `validate_provider_config` で厳格にチェック

## 4. 文書化標準

### 4.1 仕様書 (SPEC.md)
- **フォーマット**: マークダウン
- **必須項目**: 概要, FR/NF要件リスト, 技術制約

### 4.2 詳細設計書 (BLUEPRINT.md)
- **コードスニペット**: 実装の意図を伝えるための短いコード例
- **構造図**: 必要に応じてASCIIアートやMermaidで補足

### 4.3 バージョン管理
- **コミットメッセージ**: Conventional Commits に従う (例: `feat: add provider`, `fix: cache logic`)
- **Gitフロー**: featureブランチで開発し、PRレビューを経てmainへマージ

## 5. 将来の開発ガイドライン

### 5.1 機能追加プロセス
1. **要件定義**: `SPEC.md` にFRを追加
2. **設計**: `BLUEPRINT.md` に実装方針を追記
3. **実装**: `llminfo_cli/` 以下の適切なモジュールにコードを追加
4. **設定**: 必要であれば `providers.yml` を更新
5. **テスト**: 単体テスト・統合テストを追加
6. **文書化**: `README.md` を更新

### 5.2 変更管理
- **非互換変更**: ユーザー設定 (`providers.yml`) の互換性に注意
- **移行ガイド**: 設定フォーマット変更時は自動移行または明確なガイドを提供

## 6. メンテナンスルール

### 6.1 コード品質
- **リンティング**: `ruff` でスタイル統一
- **型チェック**: `mypy` で型安全性を確保
- **テスト**: `pytest` で回帰テストを実行

### 6.2 依存関係管理
- **定期更新**: セキュリティパッチの適用
- **互換性確認**: メジャーバージョンアップ時の動作検証

## 7. 新機能のテンプレート

### 7.1 仕様書テンプレート
```markdown
### FR-XXX: [機能名]
- **説明**: 機能の明確な説明
- **ユーザーニーズ**: 解決する課題
- **受入基準**:
  - [ ] 基準1
  - [ ] 基準2
- **依存関係**: 既存機能への影響
```

### 7.2 詳細設計書テンプレート
```markdown
### [機能名] 実装

#### アーキテクチャ
(変更箇所の説明とコードスニペット)

#### 統合ポイント
- **CLI**: コマンド/オプションの変更
- **Config**: 設定ファイルの変更

#### テスト戦略
- 単体テスト: ...
- 統合テスト: ...
```

## 8. レビュープロセス

### 8.1 コードレビュー基準
- 設計ルール (DesignRule.md) への準拠
- コーディングルール (CodingTestingRule.md) への準拠
- テストの網羅性

### 8.2 ドキュメントレビュー
- 技術的な正確性
- 最新の実装との整合性